name: Store Sync

on:
  workflow_dispatch:
  issues:
    types: [reopened]
  schedule:
    - cron: '0 * * * *'

jobs:
  process-updates:
    runs-on: ubuntu-latest
    if: github.event_name != 'issues' || contains(github.event.issue.labels.*.name, 'stored-object')
    permissions:
      issues: write
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          
      - name: Install dependencies
        run: pip install gh-store
          
      - name: Process Updates
        env:
          EVENT_NAME: ${{ github.event_name }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          python - <<'PY'
          import json
          import os
          import subprocess
          import urllib.parse
          import urllib.request

          token = os.environ["GITHUB_TOKEN"]
          repo = os.environ["REPO"]
          event_name = os.environ.get("EVENT_NAME", "")
          issue_number = os.environ.get("ISSUE_NUMBER", "").strip()

          def run_process_updates(issue: str) -> None:
              print(f"Processing issue #{issue}")
              subprocess.run(
                  [
                      "python",
                      "-m",
                      "gh_store",
                      "process-updates",
                      "--issue",
                      str(issue),
                      "--token",
                      token,
                      "--repo",
                      repo,
                  ],
                  check=True,
              )

          # Issue-triggered path: process only the triggering issue.
          if event_name == "issues" and issue_number:
              run_process_updates(issue_number)
              raise SystemExit(0)

          # Schedule/workflow_dispatch path: process all open stored-object issues.
          labels = "stored-object"
          page = 1
          issues_to_process = []
          headers = {
              "Accept": "application/vnd.github+json",
              "Authorization": f"Bearer {token}",
              "X-GitHub-Api-Version": "2022-11-28",
          }

          while True:
              params = urllib.parse.urlencode(
                  {
                      "state": "open",
                      "labels": labels,
                      "per_page": 100,
                      "page": page,
                  }
              )
              url = f"https://api.github.com/repos/{repo}/issues?{params}"
              req = urllib.request.Request(url, headers=headers)
              with urllib.request.urlopen(req) as response:
                  payload = json.loads(response.read().decode("utf-8"))

              if not payload:
                  break

              for issue in payload:
                  # Filter out pull requests defensively.
                  if "pull_request" in issue:
                      continue
                  issues_to_process.append(str(issue["number"]))

              if len(payload) < 100:
                  break
              page += 1

          if not issues_to_process:
              print("No open stored-object issues to process.")
              raise SystemExit(0)

          print(f"Bulk processing {len(issues_to_process)} open stored-object issues.")
          for issue in issues_to_process:
              run_process_updates(issue)
          PY

  notify-deploy:
    needs: process-updates
    runs-on: ubuntu-latest
    env:
      DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
    steps:
      - name: Trigger frontend deploy
        run: |
          TARGET_REF="${GITHUB_REF#refs/heads/}"
          if [ -z "$TARGET_REF" ] || [ "$TARGET_REF" = "$GITHUB_REF" ]; then
            TARGET_REF="${DEFAULT_BRANCH}"
          fi

          echo "Dispatching frontend deploy for ref: ${TARGET_REF}"
          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/2_deploy-frontend.yml/dispatches \
            -d "{\"ref\":\"${TARGET_REF}\"}"
